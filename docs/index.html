<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>International Fantasy — Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg-url: url("./international_2025_ls_3_4k.jpg"); }
    body{
      min-height:100vh;
      color:#e6e8eb;
      background:
        linear-gradient(180deg, rgba(14,16,20,.74), rgba(14,16,20,.74)),
        var(--bg-url) center/cover fixed no-repeat;
    }
    .card{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 16px;
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    .chip{ background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }
    input, select { color:#111827 !important; background:#ffffff !important; }
    input:focus, select:focus {
      outline: 2px solid rgba(99,102,241,.6);
      box-shadow: 0 0 0 4px rgba(99,102,241,.20);
    }
    th, td { white-space: nowrap; }
  </style>
</head>
<body>
  <header class="max-w-6xl mx-auto px-4 pt-10 pb-6 flex items-center justify-between">
    <div>
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight drop-shadow">INTERNATIONAL FANTASY</h1>
      <p class="text-sm text-gray-300">Group Stage + Playoffs Fantasy</p>
    </div>
    <div id="authBox" class="flex gap-3 items-center"></div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <div class="flex gap-3 items-center mb-6">
      <span class="px-3 py-1 rounded-full chip text-sm">TI 2025</span>
      <a href="submit.html" class="ml-auto px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-white font-semibold shadow">Submit Lineup</a>
    </div>

    <section class="card rounded-2xl p-4 md:p-6">
      <div class="flex flex-col md:flex-row md:items-end gap-3 mb-4">
        <div class="grow">
          <label class="block text-sm mb-1">Tournament</label>
          <input class="w-full rounded-lg px-3 py-2" value="ti2025" disabled />
        </div>
        <div class="grow">
          <label class="block text-sm mb-1">Sort</label>
          <select id="lb_sort" class="w-full rounded-lg px-3 py-2">
            <option value="total_desc">Total (high → low)</option>
            <option value="total_asc">Total (low → high)</option>
            <option value="date_desc">By Date (latest first)</option>
            <option value="date_asc">By Date (oldest first)</option>
          </select>
        </div>
        <button id="btnLoadLb" class="h-10 px-4 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-semibold shadow">Load Leaderboards</button>
      </div>

      <div id="lbDates" class="flex flex-wrap gap-2 mb-3"></div>
      <div id="lbStatus" class="text-sm text-gray-300 mb-3"></div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-gray-300" id="lbHead"></thead>
          <tbody id="lbRows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { setupAuthUI } from "./assets/auth-ui.js";

    const app = initializeApp({
      apiKey:"AIzaSyAx8jWSAZdR_rzgVP8XumxNOvsy86bjl-Q",
      authDomain:"internationalfantasy2025.firebaseapp.com",
      projectId:"internationalfantasy2025",
      storageBucket:"internationalfantasy2025.firebasestorage.app",
      messagingSenderId:"864977028555",
      appId:"1:864977028555:web:8038b630cba08cc661624e"
    });

    const { db } = setupAuthUI({ app, headerEl: document.getElementById('authBox'), cardClass: 'card' });

    const CURRENT_TID = "ti2025";
    const lbStatus = document.getElementById('lbStatus');
    const lbRows = document.getElementById('lbRows');
    const lbHead = document.getElementById('lbHead');
    const lbDates = document.getElementById('lbDates');
    const lbSort = document.getElementById('lb_sort');

    document.getElementById('btnLoadLb').onclick = async () => {
      lbStatus.textContent = 'Loading…';
      lbRows.innerHTML = ''; lbHead.innerHTML = ''; lbDates.innerHTML='';

      try{
        const snaps = await getDocs(collection(db, 'leaderboards'));
        const dayDocs = [];
        snaps.forEach(d => { if (d.id.startsWith(CURRENT_TID + '_')) dayDocs.push({ id: d.id, data: d.data() }); });
        if (!dayDocs.length){ lbStatus.textContent = 'No leaderboards yet.'; return; }

        let dateKeys = dayDocs.map(x => x.id.split('_')[1]).sort();
        if (lbSort.value === 'date_desc') dateKeys.reverse();

        lbHead.innerHTML = '<tr><th class="py-2 pr-4">Manager</th>' +
          dateKeys.map((dk,i)=>`<th class="py-2 pr-4">Day ${i+1}<br><span class="text-xs text-gray-400">${dk}</span></th>`).join('') +
          '<th class="py-2 pr-4">Total</th></tr>';

        const managerSet = new Set();
        const pointsByManager = new Map();
        for (const {id, data} of dayDocs){
          const dk = id.split('_')[1];
          (data.entries||[]).forEach(e => {
            managerSet.add(e.mid);
            if (!pointsByManager.has(e.mid)) pointsByManager.set(e.mid, { by: new Map(), total: 0 });
            pointsByManager.get(e.mid).by.set(dk, Number(e.totalPoints||0));
            pointsByManager.get(e.mid).total += Number(e.totalPoints||0);
          });
        }

        const uids = Array.from(managerSet);
        const nameMap = new Map();
        await Promise.all(uids.map(async uid => {
          try { const s = await getDoc(doc(db, 'users', uid)); nameMap.set(uid, s.exists() ? (s.data().name||uid) : uid); }
          catch { nameMap.set(uid, uid); }
        }));

        let rows = uids.map(uid => {
          const rec = pointsByManager.get(uid) || { by: new Map(), total: 0 };
          const cells = dateKeys.map(dk => (rec.by.get(dk)||0));
          return { name: nameMap.get(uid)||uid, cells, total: rec.total };
        });

        if (lbSort.value.startsWith('total_')){
          rows.sort((a,b)=> lbSort.value==='total_desc' ? b.total - a.total : a.total - b.total);
        }

        dateKeys.forEach((dk,i)=>{
          const chip = document.createElement('span');
          chip.className = 'px-3 py-1 rounded-full chip text-xs';
          chip.textContent = `Day ${i+1} – ${dk}`;
          lbDates.appendChild(chip);
        });

        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2 pr-4 font-medium">${r.name}</td>` +
            r.cells.map(v=>`<td class="py-2 pr-4">${Number(v||0).toFixed(2)}</td>`).join('') +
            `<td class="py-2 pr-4 font-semibold">${Number(r.total||0).toFixed(2)}</td>`;
          lbRows.appendChild(tr);
        });

        lbStatus.textContent = `${rows.length} managers`;
      }catch(err){
        lbStatus.textContent = 'Error: ' + (err.message || err);
      }
    };
  </script>
</body>
</html>
