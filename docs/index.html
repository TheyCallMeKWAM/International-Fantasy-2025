<!doctype html>
<html lang="en">
<head>
  <!-- Styles/structure consistent with your earlier pages. :contentReference[oaicite:2]{index=2} :contentReference[oaicite:3]{index=3} -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>International Fantasy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg-url: url("./international_2025_ls_3_4k.jpg"); }
    body{
      min-height:100vh;
      color:#e6e8eb;
      background:
        linear-gradient(180deg, rgba(14,16,20,.74), rgba(14,16,20,.74)),
        var(--bg-url) center/cover fixed no-repeat;
    }
    .card{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 16px;
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    .chip{ background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }
    .chip-btn{ cursor:pointer; user-select:none; transition:all .2s ease; }
    .chip-btn.active{ background:#6366f1; border-color:#818cf8; color:white; }

    *{ scrollbar-width: thin; scrollbar-color: rgba(148,163,184,.6) transparent; }
    ::-webkit-scrollbar{ width:10px; height:10px; }
    ::-webkit-scrollbar-track{
      background: linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
      border-radius: 9999px;
    }
    ::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg,rgba(148,163,184,.85),rgba(203,213,225,.85));
      border-radius: 9999px; border: 2px solid rgba(17,24,39,.45);
    }
    ::-webkit-scrollbar-thumb:hover{
      background: linear-gradient(180deg,rgba(180,193,210,.95),rgba(226,232,240,.95));
    }

    .rank-badge{ font-variant-numeric: tabular-nums; }
    .medal-1{ background: linear-gradient(135deg,#ffd700,#ffb100); color:#111; }
    .medal-2{ background: linear-gradient(135deg,#c0c0c0,#a8a8a8); color:#111; }
    .medal-3{ background: linear-gradient(135deg,#cd7f32,#b36a25); color:#111; }

    .podium{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:.9rem; }
    .podium > .podium-card{ transform-origin:center bottom; }
    .podium > .first{ order:2; transform: translateY(-6px) scale(1.03); }
    .podium > .second{ order:1; }
    .podium > .third{ order:3; }
    .podium .card{ min-height:140px; }
    @media (min-width:768px){ .podium .card{ min-height:165px; } }

    .flip-animate{ transition: transform .5s cubic-bezier(.2,.7,.2,1), opacity .3s ease; will-change: transform; }
    .trend-up{ color:#34d399; } .trend-down{ color:#f87171; } .trend-flat{ color:#9ca3af; }
    .details{ display:none; } .row-open .details{ display:block; }

    .flip-card{ cursor:pointer; }
    .flip-inner{ position:relative; width:100%; height:100%; }
    .flip-face{
      position:absolute; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:.6rem; padding:1rem;
      transition: transform .45s cubic-bezier(.2,.7,.2,1), opacity .3s ease;
      transform: rotateY(0); opacity:1;
    }
    .flip-face.back{
      transform: rotateY(180deg);
      opacity:0;
      justify-content:center; align-items:center;
      overflow:hidden; padding:1rem;
    }
    .flipped .flip-face.front{ transform: rotateY(180deg); opacity:0; pointer-events:none; }
    .flipped .flip-face.back{  transform: rotateY(0);    opacity:1; pointer-events:auto; }

    .mini-columns{
      width:100%; max-width:560px;
      display:grid; grid-template-columns: 1fr 1fr; gap:22px;
      align-items:start;
    }
    .mini-grid{ display:grid; grid-template-columns: 1fr auto; column-gap:18px; row-gap:.35rem; font-size:.95rem; }

    .popover{ position:relative; }
    .popover-menu{
      position:absolute; top:110%; right:0;
      background: rgba(17,24,39,.94);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.5);
      padding: .35rem; min-width: 180px;
      backdrop-filter: blur(8px);
      display: none; z-index: 50;
    }
    .popover.open .popover-menu{ display:block; }
    .menu-item{ padding: .5rem .65rem; border-radius: 8px; cursor: pointer; white-space: nowrap; }
    .menu-item:hover{ background: rgba(99,102,241,.25); }
  </style>

  <script>
    // Phase groupings you’re using
    window.phaseConfig = {
      ti2024: { "Group Stage":[1,2,3,4], "Event Playoffs":[5,6,7], "Main Event":[8,9,10] },
      ti2025: { "Group Stage & Special Eliminator":[1,2,3,4], "Playoffs":[5,6,7,8] }
    };
  </script>
</head>
<body>
  <header class="max-w-6xl mx-auto px-4 pt-10 pb-6 flex items-center justify-between">
    <div>
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight drop-shadow">INTERNATIONAL FANTASY</h1>
    </div>
    <div id="authBox" class="flex gap-3 items-center"></div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <div class="flex flex-wrap gap-3 items-center mb-6">
      <span id="pill-2025" class="px-3 py-1 rounded-full chip chip-btn text-sm">TI 2025</span>
      <span id="pill-2024" class="px-3 py-1 rounded-full chip chip-btn text-sm">TI 2024</span>
      <a href="submit.html" class="ml-auto px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-white font-semibold shadow">Submit Lineup</a>
    </div>

    <section class="card rounded-2xl p-4 md:p-6">
      <div id="lbStatus" class="text-sm text-gray-300 mb-4"></div>

      <div class="flex flex-wrap items-center gap-2 mb-4">
        <div id="phaseTabsInner" class="flex flex-wrap gap-2"></div>

        <div id="daySortBox" class="popover ml-auto">
          <button id="daySortBtn" type="button" aria-expanded="false"
                  class="px-3 py-1 rounded-full chip chip-btn text-sm inline-flex items-center gap-1">
            <span id="daySortLabel">Sort by Day</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div id="daySortMenu" class="popover-menu"></div>
        </div>
      </div>

      <div id="podium" class="podium mb-6"></div>

      <div class="max-h-[520px] overflow-auto rounded-xl border border-white/15">
        <ul id="lbList" class="divide-y divide-white/10"></ul>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { setupAuthUI } from "./assets/auth-ui.js"; /* header UI only, no protected reads. :contentReference[oaicite:4]{index=4} */

    // Firebase
    const app = initializeApp({
      apiKey:"AIzaSyAx8jWSAZdR_rzgVP8XumxNOvsy86bjl-Q",
      authDomain:"internationalfantasy2025.firebaseapp.com",
      projectId:"internationalfantasy2025",
      storageBucket:"internationalfantasy2025.firebasestorage.app",
      messagingSenderId:"864977028555",
      appId:"1:864977028555:web:8038b630cba08cc661624e"
    });
    const { db } = setupAuthUI({ app, headerEl: document.getElementById('authBox'), cardClass: 'card' });

    // Elements
    const pill2025 = document.getElementById('pill-2025');
    const pill2024 = document.getElementById('pill-2024');
    const phaseTabsInner = document.getElementById('phaseTabsInner');
    const lbStatus = document.getElementById('lbStatus');
    const podiumEl = document.getElementById('podium');
    const listEl   = document.getElementById('lbList');
    const daySortBox = document.getElementById('daySortBox');
    const daySortBtn = document.getElementById('daySortBtn');
    const daySortLabel = document.getElementById('daySortLabel');
    const daySortMenu = document.getElementById('daySortMenu');

    // State
    let currentTid = 'ti2025';
    let currentPhase = null;
    let prevRanks = new Map();
    let unsub = null;
    let cache = { ti2024: null, ti2025: null };
    let sortByDayIndex = null;

    // UI helpers
    function markYearPillActive(){
      pill2025.classList.toggle('active', currentTid==='ti2025');
      pill2024.classList.toggle('active', currentTid==='ti2024');
    }
    function buildInnerPhaseTabs(){
      phaseTabsInner.innerHTML = '';
      const conf = window.phaseConfig[currentTid] || {};
      const phases = Object.keys(conf);
      if (currentPhase && !phases.includes(currentPhase)) currentPhase = null;
      phases.forEach(phase=>{
        const el = document.createElement('span');
        el.className = 'px-3 py-1 rounded-full chip chip-btn text-sm ' + (phase===currentPhase?'active':'');
        el.textContent = phase;
        el.onclick = ()=>{
          currentPhase = (currentPhase === phase) ? null : phase;
          renderFromCache();
        };
        phaseTabsInner.appendChild(el);
      });
    }
    function buildDaySortMenu(dayCount){
      daySortMenu.innerHTML='';
      const any=document.createElement('div');
      any.className='menu-item text-sm text-gray-200';
      any.textContent='Total (all days)';
      any.onclick=()=>{ sortByDayIndex=null; daySortLabel.textContent='Sort by Day'; renderFromCache(); daySortBox.classList.remove('open'); daySortBtn.setAttribute('aria-expanded','false'); };
      daySortMenu.appendChild(any);
      for(let i=1;i<=dayCount;i++){
        const item=document.createElement('div');
        item.className='menu-item text-sm text-gray-200';
        item.textContent=`Day ${i}`;
        item.onclick=()=>{ sortByDayIndex=i; daySortLabel.textContent=`Day ${i}`; renderFromCache(); daySortBox.classList.remove('open'); daySortBtn.setAttribute('aria-expanded','false'); };
        daySortMenu.appendChild(item);
      }
    }
    daySortBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const open = daySortBox.classList.toggle('open');
      daySortBtn.setAttribute('aria-expanded', String(open));
    });
    document.addEventListener('click', (e)=>{
      if (!daySortBox.contains(e.target)){
        daySortBox.classList.remove('open');
        daySortBtn.setAttribute('aria-expanded','false');
      }
    });

    const fmt = (n)=>Number(n||0).toFixed(2);
    const trend = (prev, curr) => {
      if (prev==null) return {icon:'→', cls:'trend-flat', delta:0};
      const d = prev - curr;
      if (d>0)  return {icon:'↑', cls:'trend-up', delta:d};
      if (d<0)  return {icon:'↓', cls:'trend-down', delta:Math.abs(d)};
      return {icon:'→', cls:'trend-flat', delta:0};
    };

    /* ---------- Podium ---------- */
    function renderPodium(rows){
      podiumEl.innerHTML = '';
      const [first, second, third] = [rows[0], rows[1], rows[2]];
      if (!first) return;

      const cards = [];
      if (second) cards.push({r: second, place:2, pos:'second', medal:'medal-2'});
      cards.push({r: first, place:1, pos:'first',  medal:'medal-1'});
      if (third)  cards.push({r: third,  place:3, pos:'third',  medal:'medal-3'});

      cards.forEach(({r,place,pos,medal})=>{
        const details = Array.isArray(r._details) ? r._details : [];
        const maxShown = 10;
        const normalized = Array.from({length: Math.min(maxShown, details.length)}, (_,i)=> details[i] || {label:`Day ${i+1}`, points:0});
        const left  = normalized.slice(0,5);
        const right = normalized.slice(5,10);
        const colHTML = arr => arr.map(d=>`
          <div class="text-gray-300">${d.label}</div>
          <div class="text-right font-semibold">${fmt(d.points)}</div>
        `).join('');

        const t = trend(prevRanks.get(r.uid), place);
        const el = document.createElement('div');
        el.className = `podium-card ${pos} flip-card`;
        el.dataset.uid = r.uid;
        el.dataset.key = r.uid;
        el.innerHTML = `
          <div class="flip-inner card rounded-2xl p-4 text-center">
            <div class="flip-face front">
              <div class="inline-flex items-center gap-2 mb-2 justify-center">
                <span class="px-2 py-0.5 rounded rank-badge text-xs ${medal}">#${place}</span>
                <span class="${t.cls} text-sm">${t.icon}${t.delta?` ${t.delta}`:''}</span>
              </div>
              <div class="text-lg font-bold">${r.name}</div>
              <div class="text-2xl font-extrabold mt-1">${fmt(r.total)}</div>
            </div>
            <div class="flip-face back">
              <div class="mini-columns">
                <div class="mini-grid">${colHTML(left)}</div>
                <div class="mini-grid">${colHTML(right)}</div>
              </div>
            </div>
          </div>`;
        podiumEl.appendChild(el);
      });

      podiumEl.querySelectorAll('.flip-card').forEach(el=>{
        el.addEventListener('click', ()=> el.classList.toggle('flipped'));
      });
    }

    /* ---------- List ---------- */
    function flipAnimate(container, updater){
      const first = new Map();
      Array.from(container.children).forEach(el => first.set(el.dataset.key, el.getBoundingClientRect()));
      updater();
      Array.from(container.children).forEach(el=>{
        const key = el.dataset.key;
        const last = el.getBoundingClientRect();
        const f = first.get(key);
        if (!f) return;
        const dx = f.left - last.left;
        const dy = f.top  - last.top;
        el.style.transform = `translate(${dx}px, ${dy}px)`;
        el.style.opacity = '0.7';
        requestAnimationFrame(()=>{
          el.classList.add('flip-animate');
          el.style.transform = '';
          el.style.opacity = '1';
          el.addEventListener('transitionend', ()=>el.classList.remove('flip-animate'), {once:true});
        });
      });
    }

    function renderList(rows, dayLabelsByUid){
      flipAnimate(listEl, () => {
        listEl.innerHTML = rows.slice(3).map((r,idx)=>{
          const rank = idx + 4;
          const prev = prevRanks.get(r.uid);
          const t = trend(prev, rank);
          const detailsRows = (dayLabelsByUid[r.uid]||[]).map(x=>`
            <div class="grid grid-cols-2 text-xs py-0.5">
              <div class="text-gray-300">${x.label}</div>
              <div class="text-right font-semibold">${fmt(x.points)}</div>
            </div>
          `).join('');
          return `
            <li class="px-4 py-3 cursor-pointer" data-key="${r.uid}">
              <div class="flex items-center gap-3">
                <span class="w-10 shrink-0 text-right font-semibold tabular-nums">#${rank}</span>
                <span class="${t.cls} w-8 shrink-0">${t.icon}${t.delta?` ${t.delta}`:''}</span>
                <span class="flex-1 font-medium">${r.name}</span>
                <span class="text-sm text-gray-300">Total</span>
                <span class="w-24 text-right font-semibold">${fmt(r.total)}</span>
              </div>
              <div class="details mt-2 pl-10 pr-2">
                <div class="border-t border-white/10 pt-2">
                  ${detailsRows || '<div class="text-xs text-gray-400">No per-day scores for this phase.</div>'}
                </div>
              </div>
            </li>
          `;
        }).join('');
      });

      listEl.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click', ()=> li.classList.toggle('row-open'));
      });
    }

    /* ---------- Leaderboard shaping (public only) ---------- */
    function rowsFromDayDocs(dayDocs){
      const managerSet = new Set();
      const nameByUid  = new Map();
      const pointsByManagerByDay = new Map();

      const sorted = [...dayDocs].sort((a,b)=> a.id.localeCompare(b.id));
      sorted.forEach(({data}, idx)=>{
        const dayIdx = idx + 1;
        const entries = Array.isArray(data.entries) ? data.entries : [];
        for (const e of entries) {
          const uid = String(e.mid);
          managerSet.add(uid);
          if (e.managerName && !nameByUid.has(uid)) nameByUid.set(uid, String(e.managerName));
          if (!pointsByManagerByDay.has(uid)) pointsByManagerByDay.set(uid, new Map());
          pointsByManagerByDay.get(uid).set(dayIdx, Number(e.totalPoints||0));
        }
      });
      return { managerSet, nameByUid, pointsByManagerByDay, dayCount: sorted.length };
    }

    function phaseDaySet(tid){
      const conf = window.phaseConfig[tid] || {};
      if (!currentPhase) return null;
      const def = conf[currentPhase];
      return new Set(def || []);
    }

    function buildRows(dayDocs, tid=currentTid){
      const { managerSet, nameByUid, pointsByManagerByDay, dayCount } = rowsFromDayDocs(dayDocs);
      buildDaySortMenu(dayCount);

      const includeDays = phaseDaySet(tid);
      const rows = Array.from(managerSet).map(uid=>{
        const byDay = pointsByManagerByDay.get(uid) || new Map();
        let total = 0; const details = [];
        byDay.forEach((points, dayIdx)=>{
          if (!includeDays || includeDays.has(dayIdx)){
            total += points;
            details.push({ label: `Day ${dayIdx}`, points });
          }
        });
        const sortDayValue = sortByDayIndex ? (byDay.get(sortByDayIndex) || 0) : null;
        const name = nameByUid.get(uid) || uid;
        return { uid, name, total, _details: details, sortDayValue };
      });

      rows.sort((a,b)=> sortByDayIndex ? (b.sortDayValue - a.sortDayValue) || (b.total - a.total) : (b.total - a.total));

      const dayLabelsByUid = {}; rows.forEach(r=>{ dayLabelsByUid[r.uid] = r._details; });
      return { rows, dayLabelsByUid, dayCount };
    }

    /* ---------- Fetchers (leaderboards only) ---------- */
    function docIsForTid(id, data, tid){
      // Prefer explicit field; fallback to tolerant ID match
      if (data && typeof data.tid === 'string') return data.tid === tid;
      return id.toLowerCase().includes(tid.toLowerCase());
    }

    async function loadYear(tid){
      if (unsub) { try{unsub();}catch{} unsub=null; }
      lbStatus.textContent = `Listening for ${tid.toUpperCase()} — ${currentPhase || 'Overall'}…`;

      const coll = collection(db,'leaderboards');
      unsub = onSnapshot(coll, snaps=>{
        const dayDocs=[];
        snaps.forEach(d=>{
          const data = d.data() || {};
          if (docIsForTid(d.id, data, tid)) dayDocs.push({id:d.id, data});
        });
        cache[tid]=dayDocs;
        renderFromCache();
      }, (err)=> console.warn('leaderboard watch error', err?.code || err));
    }

    /* ---------- Render ---------- */
    function renderFromCache(){
      markYearPillActive(); buildInnerPhaseTabs();

      const bundle=currentTid==='ti2024'?cache.ti2024:cache.ti2025;

      if(!bundle || !bundle.length){
        podiumEl.innerHTML = '';
        listEl.innerHTML = '';
        lbStatus.textContent = `0 managers — ${currentTid.toUpperCase()} • ${currentPhase || 'Overall'}`;
        return;
      }

      const { rows, dayLabelsByUid } = buildRows(bundle, currentTid);

      const nextRanks=new Map(); rows.forEach((r,i)=> nextRanks.set(r.uid,i+1));
      renderPodium(rows); renderList(rows, dayLabelsByUid);
      lbStatus.textContent = `${rows.length} managers — ${currentTid.toUpperCase()} • ${currentPhase||'Overall'}${sortByDayIndex?` • Sorted by Day ${sortByDayIndex}`:''}`;
      prevRanks=nextRanks;
    }

    /* ---------- Switch year ---------- */
    function switchYear(toTid){
      currentTid=toTid; prevRanks=new Map(); currentPhase=null; sortByDayIndex=null;
      daySortLabel.textContent='Sort by Day'; daySortBox.classList.remove('open'); daySortBtn.setAttribute('aria-expanded','false');
      buildInnerPhaseTabs(); loadYear(toTid);
    }

    pill2025.addEventListener('click', ()=>{ if(currentTid!=='ti2025') switchYear('ti2025'); });
    pill2024.addEventListener('click', ()=>{ if(currentTid!=='ti2024') switchYear('ti2024'); });

    // Boot on TI2025
    switchYear('ti2025');
  </script>
</body>
</html>
